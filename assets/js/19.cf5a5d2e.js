(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{504:function(t,s,a){t.exports=a.p+"assets/img/vnode.a03b5631.png"},505:function(t,s,a){t.exports=a.p+"assets/img/vnode-path.114c31c0.png"},665:function(t,s,a){"use strict";a.r(s);var n=a(44),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("p",[t._v("vue.js权威指南 第18章")]),t._v(" "),n("p",[t._v("VM选项的DOM部分")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("新增 render")]),t._v(" "),n("p",[t._v("Vue.js 2.0新增了render字段，render字段是一个function，运行时会把模板中的内容经过Vue的编译，转换成渲染方法存入render字段，然后再执行。如果发现render字段已经存在，则跳过模板解析过程直接渲染。因此，在Vue.js 2.0中写一个模板和写一个render function是等价的。")])])]),t._v(" "),n("h3",{attrs:{id:"服务端渲染"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#服务端渲染"}},[t._v("#")]),t._v(" 服务端渲染")]),t._v(" "),n("p",[t._v("服务端渲染是Vue.js 2.0的新特性，它提供的接口如下：")]),t._v(" "),n("ul",[n("li",[t._v("新增 renderToString(component, done)方法")]),t._v(" "),n("li",[t._v("新增 renderToStream(component) 方法")])]),t._v(" "),n("h2",{attrs:{id:"virtual-dom"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#virtual-dom"}},[t._v("#")]),t._v(" Virtual DOM")]),t._v(" "),n("h3",{attrs:{id:"_1-创建vnode对象模拟dom树"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建vnode对象模拟dom树"}},[t._v("#")]),t._v(" 1. 创建VNode对象模拟DOM树")]),t._v(" "),n("p",[t._v("在Vue.js 2.0中，Virtual DOM是通过VNode类来表达的，每一个原生DOM元素或Vue组件都对应一个VNode对象。下面是VNode的数据结构：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(504),alt:""}})]),t._v(" "),n("h4",{attrs:{id:"_1-vnode"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-vnode"}},[t._v("#")]),t._v(" 1. VNode")]),t._v(" "),n("p",[t._v("VNode用来描述DOM节点的主要信息，包括 "),n("code",[t._v("tag")]),t._v("、"),n("code",[t._v("text")]),t._v("、"),n("code",[t._v("elm")]),t._v("、"),n("code",[t._v("data")]),t._v("、"),n("code",[t._v("parent")]),t._v("、"),n("code",[t._v("children")]),t._v("等属性。它主要有两种生成方式，其中一种是由普通DOM元素生成；另一种是由Vue组件生成。")]),t._v(" "),n("p",[t._v("这两种方式生成的VNode对象的区别主要是在 "),n("code",[t._v("componentOptions")]),t._v(" 的值上，如果是普通DOM元素生成的VNode对象，该值为空。")]),t._v(" "),n("h4",{attrs:{id:"_2-vnodecomponentoptions"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-vnodecomponentoptions"}},[t._v("#")]),t._v(" 2. VNodeComponentOptions")]),t._v(" "),n("p",[t._v("VNode中componentOptions属性的数据类型用来描述通过Vue组件生成VNode对象的一些组件相关参数，包括Ctor、propData、listeners、parent、children、tag等属性。")]),t._v(" "),n("h4",{attrs:{id:"_3-vnodedata"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-vnodedata"}},[t._v("#")]),t._v(" 3. VNodeData")]),t._v(" "),n("p",[t._v("VNode中data属性的数据类型用来描述VNode包含的一些节点数据，包括 slot、ref、staticClass、style、class、props、attrs、transition、directives等。")]),t._v(" "),n("h4",{attrs:{id:"_4-vnodedirective"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-vnodedirective"}},[t._v("#")]),t._v(" 4. VNodeDirective")]),t._v(" "),n("p",[t._v("VNodeData中directives属性的数据类型用来描述 VNode 存储的指令数据，包括：name、value、oldValue、arg、modifiers等。")]),t._v(" "),n("p",[t._v("下图是，VNode的生成过程。（p.302，i.320）")]),t._v(" "),n("p",[n("img",{attrs:{src:a(505),alt:""}})]),t._v(" "),n("p",[t._v("VNode生成最关键的点是，通过回调 "),n("code",[t._v("render()")]),t._v("，render方法在Vue.js 2.0中有两种生成方式：")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("第一种：直接在Vue对象的"),n("code",[t._v("option")]),t._v("中添加"),n("code",[t._v("render")]),t._v("字段；")])]),t._v(" "),n("li",[n("p",[t._v("第二种：像Vue.js 1.x那样写一个模板或指定一个el根元素，它会首先转换成模板，经过HTML语法解析器生成一个 AST抽象语法树，对语法树做优化，然后把语法树转换成代码片段，最后通过代码片段生成function添加option的render字段中。")]),t._v(" "),n("p",[t._v("在整个过程中，特别值得一提的是AST优化的过程，它主要做了两件事情：")]),t._v(" "),n("ul",[n("li",[t._v("检测出静态的 "),n("code",[t._v("class")]),t._v(" 名和 "),n("code",[t._v("attributes")]),t._v("，这样它们在初始化渲染之后就永远都不会再被比对了。")]),t._v(" "),n("li",[t._v("检测出最大的静态子树，并且从render渲染函数中萃取出来。这样在每次重渲染时，它就会直接重用完全相同的Vnode，同时跳过比对。")])])])]),t._v(" "),n("p",[t._v("下面，我们通过一段简单的代码，看一下编译后的渲染函数：")]),t._v(" "),n("div",{staticClass:"language-vue extra-class"},[n("pre",{pre:!0,attrs:{class:"language-vue"}},[n("code",[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("template")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("h1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" hello {{who}}"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("h1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("template")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token script"}},[n("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    el"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'#app'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      who"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'leon'")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),n("p",[t._v("我们在Vue对象中，指定了el根元素，经过一系列的编译后，最终生成 render方法：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("_h")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("_e")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'div'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" staticAttrs"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'id'")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'app'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("_h")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("_e")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'h1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Hello '")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("_s")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("who"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("可以看到，render方法使用了with方法来包裹代码块，with(this)中的属性和方法相当于通过this来调用，这样写是为了减少代码量。")]),t._v(" "),n("p",[t._v("这里的this指向的是Vue对象实例，"),n("code",[t._v("_h")]),t._v("和"),n("code",[t._v("_e")]),t._v("方法都是和VNode相关创建的方法。源码定义如下：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// src/core/instance/render.js")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_h "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" renderElementWithChildren\n"),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_e "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" renderElement\n")])])]),n("p",[n("code",[t._v("_h")]),t._v("和"),n("code",[t._v("_e")]),t._v("方法分别是 "),n("code",[t._v("renderElementWithChildren")]),t._v("、"),n("code",[t._v("renderElement")]),t._v("，源码定义见："),n("code",[t._v("src/core/vdom/create-element.js")])])])}),[],!1,null,null,null);s.default=e.exports}}]);